{% extends 'base.html' %}

{% block title %}参与投票{% endblock %}

{% block content %}
    <h2>{{ poll.question }}</h2>
    
    <form method="post" id="voteForm">
        <input type="hidden" name="fingerprint" id="fingerprintInput">
        {% for option in options %}
        <div class="vote-option">
            <input type="radio" 
                   id="option{{ option.id }}" 
                   name="option" 
                   value="{{ option.id }}" 
                   required>
            <label for="option{{ option.id }}">
                {{ option.option_text }}
            </label>
        </div>
        {% endfor %}
        
        <div class="form-actions">
            <button type="submit" class="btn primary">提交投票</button>
            <a href="{{ url_for('results', poll_id=poll.id) }}" class="btn">查看结果</a>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('voteForm');
            const fingerprintInput = document.getElementById('fingerprintInput');

            const showError = (message) => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flash-message';
                errorDiv.textContent = message;
                form.insertBefore(errorDiv, form.firstChild);
                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    setTimeout(() => errorDiv.remove(), 600);
                }, 3000);
            };

            try {
                const fingerprint = await getBrowserFingerprint();
                if (!fingerprint) {
                    showError('无法获取浏览器指纹，请确保启用了JavaScript并刷新页面重试。');
                    setTimeout(() => location.href = "{{ url_for('index') }}", 4000);
                    return;
                }
                fingerprintInput.value = fingerprint;
            } catch (error) {
                console.error('指纹验证失败:', error);
                showError('验证失败，请确保浏览器允许必要的权限并稍后重试。');
                setTimeout(() => location.href = "{{ url_for('index') }}", 4000);
            }
        });
    </script>
{% endblock %}