{% extends 'base.html' %}

{% block title %}参与投票{% endblock %}

{% block content %}
    <h2 class="page-title">{{ poll.question }}</h2>
    
    <form method="post" id="voteForm" class="vote-form">
        <input type="hidden" name="fingerprint" id="fingerprintInput">
        <div class="options-list">
            {% for option in options %}
            <div class="vote-option">
                <input type="radio" 
                       id="option{{ option.id }}" 
                       name="option" 
                       value="{{ option.id }}" 
                       required>
                <label for="option{{ option.id }}" class="option-label">
                    {{ option.option_text }}
                </label>
            </div>
            {% endfor %}
        </div>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
                <span>提交投票</span>
            </button>
            <a href="{{ url_for('results', poll_id=poll.id) }}" class="btn btn-secondary">
                <span>查看结果</span>
            </a>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('voteForm');
            const fingerprintInput = document.getElementById('fingerprintInput');

            const showError = (message) => {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flash-message';
                errorDiv.textContent = message;
                form.insertBefore(errorDiv, form.firstChild);
                setTimeout(() => {
                    errorDiv.style.opacity = '0';
                    setTimeout(() => errorDiv.remove(), 600);
                }, 3000);
            };

            try {
                const fingerprint = await getBrowserFingerprint();
                if (!fingerprint) {
                    showError('无法获取浏览器指纹，请确保启用了JavaScript并刷新页面重试。');
                    setTimeout(() => location.href = "{{ url_for('index') }}", 4000);
                    return;
                }
                fingerprintInput.value = fingerprint;
            } catch (error) {
                console.error('指纹验证失败:', error);
                showError('验证失败，请确保浏览器允许必要的权限并稍后重试。');
                setTimeout(() => location.href = "{{ url_for('index') }}", 4000);
            }
        });
    </script>
{% endblock %}